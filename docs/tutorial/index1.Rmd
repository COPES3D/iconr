---
title: "The R ***iconr*** package: A Tutorial"
output: html_document
---

<style>
.figure {
   margin-top: 0px;
   margin-bottom: 20px;
}
table {
    margin-top: 0px;
    margin-bottom: 24px;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
solanas.vor.path <- "../img/solana_voronoi.png"
```
  

As stated in the ***iconr*** R package, any iconographic contents can be modeled with a geometric graph where nodes, also called **graphical units (GUs)**, linked together with edges and then analyzed with the **Graph Theory**. For the recording of large series of iconographic contents, the **GIS interface** is the most appropriate one for the user. This tutorial explains how to construct the graph _before_ using the package ***iconr***.  This tutorial offers also tipping points to facilitate the recording process. The chapter '[Dataset](https://zoometh.github.io/iconr/docs/#Dataset)' of the  ***iconr*** documentation can complete the present tutorial.

<center>

![Detail of a Late Bronze Age stelae (Solana de Cabañas, Cáceres, Spain). Credits: Museo Arqueológico Nacional, Madrid](`r solanas.vor.path`)

</center>

GIS offer multiple tools and options to facilitate the data entry.  Use of GIS offers a graphic interface and ensures the correctness of spatial relationships between GUs. Here, we only focus on the most basic ones and point out the possible short cuts or good practices. Obviously, the main GIS facility is the presence of **attributes tables** which allow to record, filter and sort GUs on many information: types, techniques, orientations, lengths, etc. The other most important GIS facilities for the recording process are:

* the snapping tools
* the measurement line
* the georeferencing tools
* 


## Always start with an **image**

The *tenet* of the ***iconr*** is to always keep the user connected with the iconographic content -- his primary data source -- and emphasise the significance of the spatial dimension for any graphical content.The image will be the reference space of the graph. So, before anything, start by opening the image decoration into a GIS (for example QGIS), or [downloading the training decoration from GitHub](https://github.com/zoometh/iconr/blob/master/docs/tutorial/img/Abela.jpg)

<center>

![](img/openImageGIS.gif){width=70%}
</center>

Whether it is not mandatory -- and not available in all GIS -- you can check the box **Non projection (or unknown/non-Earth projection)**. The projection system will not affect the next step.  

The image extent is measured in pixels with a top-left corner origin (0,0). 

<center>

![](img/coordsQGIS.gif){width=70%}
</center>

To retrieve to true scale of the decoration, you can create a scale bar and apply a simple rule of three to convert pixels into centimeters or meters. For example, if the scale belongs to another drawing, you can import it and 'georeferenced' it on the original drawing with the [*Freehand raster georeferencer* plugin](https://gvellut.github.io/FreehandRasterGeoreferencer/), and then create the scale bar

<center>

![](img/scaleAll.gif){width=70%}

</center>

To retrieve the real dimensions of each GUs, first get the pixel sizes with the Measure line tools, then apply a simple rule of three with:

* the size of the scale in pixels (native QGIS function `$length`)
* the real size of the scale in cm (here, 100 cm)
* the size of each GUs in cm

<center>

![](img/scaleRuleOfThree.gif){width=70%}

</center>

## Create the attributes dataframes for the graph elements

At first, we have to create the data structures for the [nodes](#graph.nodes.crt) and the [edges](#graph.edges.crt). Like for the decoration image, the coordinates system of the nodes and edges are irrelevant: their coordinates are measured in pixels.

### **Nodes** attributes dataframe {#graph.nodes.crt}

Nodes are created as a shapefile of `POINTS`. The attribute table of the nodes has at least four (4) fields:

1. `site` (Text)
2. `decor` (Text)
3. `id` (Integer)
4. a relevant characteristics of each node, like its `type` (Text)

<center>
  
![](img/createNodes.gif){width=70%}
  
</center>

The nodes are created near the centroids of each different graphical units (GUs). See the [Node data](https://zoometh.github.io/iconr/docs/#Node_data) part of the ***incor*** documentation

### **Edges** attributes dataframe {#graph.edges.crt}

Edges are created as a shapefile of `LINES` and the **edges** table attributes is created in the same way as nodes. Edges attribute table has at least five (5) fields:

1. `site` (Text)
2. `decor` (Text)
3. `a` (Integer)
4. `b` (Integer)
5. `type` (Text)

See the [Edge data](https://zoometh.github.io/iconr/docs/#Edge_data) part of the ***incor*** documentation

## Add graph elements

In the GIS, [add a node](#graph.enodes.add) for each GUs and [add an edge](#graph.edges.add) between two contiguous GUs

### Add **nodes** {#graph.nodes.add}

<center>
  
![](img/addNodes.gif){width=70%}
  
</center>


### Add **edges** {#graph.edges.add}

<center>
  
![](img/addEdges.gif){width=70%}
  
</center>

To understand the typology of the edges (field `type`), see the [Edge types](https://zoometh.github.io/iconr/docs/#Edge_types) part of the ***incor*** documentation

### Summary

For the Abela decoration, we have created three (3) nodes (`1`,`2`,`3`) and two (2) edges (`1-=-2`,`1-=-2`). We nammed the nodes shapefile `nodes.shp` and the edges shapefile `edges.shp` because this is their default name in the ***incor*** package

<center>
  
![](img/inputSummary.gif){width=70%}
  
</center>

## Create the **table of decorations**

A dataframe, the **table of decorations**, record the joins between the node dataframe and the edge dataframe. This dataframe could be a `.tsv` (tabulate separated-values) or `.csv` (comma separated-values)

<center>
  
![](img/createTableOfDecorations.gif){width=70%}
  
</center>

The **table of decorations** has four (4) mandatory fields:

1. `idf` (Integer)
2. `site` (Text)
3. `decor` (Text)
4. `img` (Text)

To understand the meaning of these fields, see the [Table of decorations](https://zoometh.github.io/iconr/docs/#Table_of_decorations) part of the ***incor*** documentation

## Work with the ***incor*** package

The latest development version of the ***incor*** package and its vignette can be downloaded from GitHub

```{r down,eval=FALSE, echo=TRUE}
devtools::install_github("zoometh/iconr", build_vignettes=TRUE)
```

And load the package

```{r echo=TRUE}
library(iconr)
```

To start using the package, you have first to locate your working directory. For example:

```{r echo=TRUE}
dataDir <- "C:/Users/supernova/Dropbox/My PC (supernova-pc)/Documents/iconr/docs/tutorial/extdata"
```

The you can start with the function `plot_dec_grph()` and specifying the extensions of the nodes and edges data (`shp`)

```{r echo=TRUE, out.width="60%", fig.width=8, fig.asp=750/666, fig.align="center", warning=FALSE, fig.cap="Abela stelae"}
# Decoration to be plotted
site <- "Abela"
decor <- "Abela"
# Read nodes, edges, and decorations
nds.df <- read_nds(site, decor, dataDir, format = "shp")
eds.df <- read_eds(site, decor, dataDir, format = "shp")
imgs <- read.table(paste0(dataDir, "/imgs.tsv"),
                   sep="\t", stringsAsFactors = FALSE, header = T)

# Save the plot of nodes and edges with node variable "type" as labels
# in png image format and return the image file name.
plot_dec_grph(nds.df, eds.df, imgs,
              site, decor,
              dir = dataDir,
              nd.var = "type")
```

# Summary

Once you record all your dataset (nodes, edges, table of decoration and images), you can use the ***iconr*** package

